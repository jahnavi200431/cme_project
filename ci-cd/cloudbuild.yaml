options:
  logging: CLOUD_LOGGING_ONLY

serviceAccount: "projects/my-project-app-477009/serviceAccounts/433503387155-compute@developer.gserviceaccount.com"

substitutions:
  _TAG: $SHORT_SHA
  _IMAGE: "us-central1-docker.pkg.dev/my-project-app-477009/my-artifact-repo/gke-rest-api"
  _DB_INSTANCE_CONNECTION: "my-project-app-477009:us-central1:product-db-instance"
  _DB_PORT: "5432"

availableSecrets:
  secretManager:
    - versionName: "projects/433503387155/secrets/cloud_sql_key/versions/latest"
      env: "_CLOUD_SQL_KEY"

steps:
  # ------------------------------------------------------
  # 0) Start Cloud SQL Proxy
  # ------------------------------------------------------
  - name: "gcr.io/cloudsql-docker/gce-proxy:1.33.2"
    id: "Cloud SQL Proxy"
    secretEnv: ["_CLOUD_SQL_KEY"]
    entrypoint: "/cloud_sql_proxy"
    args:
      [
        "-instances=${_DB_INSTANCE_CONNECTION}=tcp:${_DB_PORT}",
        "-credential_file=/secrets/cloud_sql_key.json"
      ]
    volumes:
      - name: "cloudsql-secret"
        path: "/secrets"
  # This step mounts the secret automatically to `/secrets/cloud_sql_key.json`

  # ------------------------------------------------------
  # 1) Terraform Init & Apply
  # ------------------------------------------------------
  - name: hashicorp/terraform:1.6.6
    entrypoint: "sh"
    id: "Terraform Init & Apply"
    args:
      - "-c"
      - |
        cd infra1
        terraform init -input=false
        terraform plan -out=tfplan -input=false
        terraform apply -input=false -auto-approve tfplan

  # ------------------------------------------------------
  # 2) Initialize Database via Proxy
  # ------------------------------------------------------
  - name: python:3.11
    id: "Init Database"
    entrypoint: "bash"
    secretEnv: ["_CLOUD_SQL_KEY"]
    args:
      - "-c"
      - |
        if [ -f .env ]; then
            set -o allexport
            source .env
            set +o allexport
        else
            echo ".env not found!"
            exit 1
        fi

        cd app
        pip install -r requirements.txt

        export DB_HOST=127.0.0.1
        export DB_PORT=5432

        INIT_DB_ONLY=true python app.py

  # ------------------------------------------------------
  # 3) Build Docker Image
  # ------------------------------------------------------
  - name: gcr.io/cloud-builders/docker
    id: "Build Docker Image"
    args: ["build", "-t", "${_IMAGE}:${_TAG}", "."]

  # ------------------------------------------------------
  # 4) Push Docker Image
  # ------------------------------------------------------
  - name: gcr.io/cloud-builders/docker
    id: "Push Docker Image"
    args: ["push", "${_IMAGE}:${_TAG}"]

  # ------------------------------------------------------
  # 5) Deploy to GKE
  # ------------------------------------------------------
  - name: gcr.io/cloud-builders/gcloud
    id: "Deploy to GKE"
    entrypoint: "bash"
    args:
      - "-c"
      - |
        gcloud container clusters get-credentials product-gke-cluster \
          --zone=us-central1-a \
          --project=my-project-app-477009

        kubectl apply -f k8s/db-secret.yaml
        kubectl apply -f k8s/deployment.yaml

        kubectl set image deployment/gke-rest-api gke-rest-api=${_IMAGE}:${_TAG}
        kubectl rollout status deployment/gke-rest-api --timeout=120s

images:
  - "${_IMAGE}:${_TAG}"
