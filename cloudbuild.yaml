# cloudbuild.yaml
# Cloud Build pipeline for GKE REST API Deployment

steps:
# ------------------------------------------------------------------------------
# 1Ô∏è‚É£ BUILD PHASE
# ------------------------------------------------------------------------------
- name: 'gcr.io/cloud-builders/docker'
  id: 'Build Docker Image'
  args:
    - 'build'
    - '-t'
    - 'us-central1-docker.pkg.dev/my-project-app-477009/my-artifact-repo/gke-rest-api:latest'
    - '.'  # Build context (current directory)

- name: 'gcr.io/cloud-builders/docker'
  id: 'Push Docker Image'
  args:
    - 'push'
    - 'us-central1-docker.pkg.dev/my-project-app-477009/my-artifact-repo/gke-rest-api:latest'

# ------------------------------------------------------------------------------
# 2Ô∏è‚É£ DEPLOY PHASE (to GKE)
# ------------------------------------------------------------------------------
- name: 'gcr.io/cloud-builders/gcloud'
  id: 'Deploy to GKE'
  entrypoint: 'bash'
  args:
    - '-c'
    - |
      echo "üì¶ Starting deployment to GKE..."

      # Get GKE credentials (so kubectl can talk to the cluster)
      gcloud container clusters get-credentials product-gke-cluster \
        --zone=us-central1-a \
        --project=my-project-app-477009

      echo "üîß Updating image in Kubernetes manifests..."
      sed -i "s|us-central1-docker.pkg.dev/my-project-app-477009/my-artifact-repo/gke-rest-api:latest|us-central1-docker.pkg.dev/my-project-app-477009/my-artifact-repo/gke-rest-api:latest|g" k8s/deployment.yaml

      echo "üöÄ Applying manifests..."
      kubectl apply -f k8s/deployment.yaml
      kubectl apply -f k8s/service.yaml

      echo "‚úÖ Deployment applied successfully."

  # Use impersonation of Cloud Build Deployer SA
  

# ------------------------------------------------------------------------------
# 3Ô∏è‚É£ POST-DEPLOYMENT CHECKS
# ------------------------------------------------------------------------------
- name: 'gcr.io/cloud-builders/gcloud'
  id: 'Post-Deployment Checks'
  entrypoint: 'bash'
  args:
    - '-c'
    - |
      echo "üîç Running basic health check on deployed service..."
      # Get the external IP of the LoadBalancer
      LB_IP=$(kubectl get svc gke-rest-api-service -o jsonpath='{.status.loadBalancer.ingress[0].ip}')

      if [ -z "$LB_IP" ]; then
        echo "‚ùå LoadBalancer IP not found. Skipping health check."
        exit 1
      fi

      echo "Checking endpoint at http://$LB_IP/products ..."
      sleep 10
      curl -f "http://$LB_IP/products" && echo "‚úÖ Health check passed." || (echo "‚ùå Health check failed!" && exit 1)

# ------------------------------------------------------------------------------
# 4Ô∏è‚É£ IMAGES TO STORE IN ARTIFACT REGISTRY
# ------------------------------------------------------------------------------
images:
  - 'us-central1-docker.pkg.dev/my-project-app-477009/my-artifact-repo/gke-rest-api:latest'

# ------------------------------------------------------------------------------
# 5Ô∏è‚É£ OPTIONS
# ------------------------------------------------------------------------------
  # 20 minutes

