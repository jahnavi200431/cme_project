# ---------------------------------------------------------------------
# üå©Ô∏è Cloud Build CI/CD Pipeline for GKE REST API Deployment
# ---------------------------------------------------------------------

 # 20 minutes total timeout

# ‚úÖ Use the Cloud Build Deployer service account (recommended)
# Replace below with your Cloud Build Deployer SA if created
serviceAccount: 'projects/my-project-app-477009/serviceAccounts/cloudbuild-deployer@my-project-app-477009.iam.gserviceaccount.com'

steps:
# ---------------------------------------------------------------------
# 1Ô∏è‚É£ BUILD PHASE ‚Äî Build Docker image
# ---------------------------------------------------------------------
- name: 'gcr.io/cloud-builders/docker'
  id: 'Build Docker Image'
  args:
    - 'build'
    - '-t'
    - 'us-central1-docker.pkg.dev/my-project-app-477009/my-artifact-repo/gke-rest-api:latest'
    - '.'
  env:
    - 'CLOUDSDK_COMPUTE_ZONE=us-central1-a'

# ---------------------------------------------------------------------
# 2Ô∏è‚É£ PUSH PHASE ‚Äî Push image to Artifact Registry
# ---------------------------------------------------------------------
- name: 'gcr.io/cloud-builders/docker'
  id: 'Push Docker Image'
  args:
    - 'push'
    - 'us-central1-docker.pkg.dev/my-project-app-477009/my-artifact-repo/gke-rest-api:latest'

# ---------------------------------------------------------------------
# 3Ô∏è‚É£ DEPLOY PHASE ‚Äî Deploy to GKE
# ---------------------------------------------------------------------
- name: 'gcr.io/cloud-builders/gcloud'
  id: 'Deploy to GKE'
  entrypoint: 'bash'
  args:
    - '-c'
    - |
      echo "üì¶ Starting deployment to GKE..."

      # Authenticate to cluster
      gcloud container clusters get-credentials product-gke-cluster \
        --zone=us-central1-a \
        --project=my-project-app-477009

      echo "üîß Updating deployment manifest image..."
      sed -i "s|image: .*|image: us-central1-docker.pkg.dev/my-project-app-477009/my-artifact-repo/gke-rest-api:latest|g" k8s/deployment.yaml

      echo "üöÄ Applying Kubernetes manifests..."
      kubectl apply -f k8s/deployment.yaml
      kubectl apply -f k8s/service.yaml

      echo "‚è≥ Waiting for rollout..."
      kubectl rollout status deployment/gke-rest-api --timeout=180s

      echo "‚úÖ Deployment successful."

# ---------------------------------------------------------------------
# 4Ô∏è‚É£ POST-DEPLOYMENT CHECKS ‚Äî Verify LoadBalancer & Health
# ---------------------------------------------------------------------
- name: 'gcr.io/cloud-builders/gcloud'
  id: 'Post-Deployment Health Check'
  entrypoint: 'bash'
  args:
    - '-c'
    - |
      echo "üîç Starting health check..."

      # Wait for LoadBalancer external IP
      MAX_RETRIES=12
      RETRY=0
      LB_IP=""

      while [ -z "$LB_IP" ] && [ $RETRY -lt $MAX_RETRIES ]; do
        echo "Waiting for LoadBalancer IP... (attempt $RETRY)"
        LB_IP=$(kubectl get svc gke-rest-api-service -o jsonpath='{.status.loadBalancer.ingress[0].ip}' --ignore-not-found)
        [ -z "$LB_IP" ] && sleep 10
        RETRY=$((RETRY+1))
      done

      if [ -z "$LB_IP" ]; then
        echo "‚ùå LoadBalancer IP not available after retries."
        kubectl get svc gke-rest-api-service -o yaml
        exit 1
      fi

      echo "‚úÖ Found LoadBalancer IP: $LB_IP"

      # Health endpoint check
      ENDPOINT="http://$LB_IP/products"
      echo "üåê Checking $ENDPOINT ..."
      for i in {1..8}; do
        if curl -fsS "$ENDPOINT"; then
          echo "‚úÖ Health check passed!"
          exit 0
        else
          echo "Attempt $i failed. Retrying..."
          sleep 5
        fi
      done

      echo "‚ùå Health check failed after retries. Fetching diagnostics..."
      kubectl get pods -o wide
      kubectl logs -l app=gke-rest-api --tail=100
      exit 1

# ---------------------------------------------------------------------
# 5Ô∏è‚É£ IMAGES ‚Äî Artifact Registry image to retain
# ---------------------------------------------------------------------
images:
  - 'us-central1-docker.pkg.dev/my-project-app-477009/my-artifact-repo/gke-rest-api:latest'

