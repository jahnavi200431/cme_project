#options:
#  timeout: '1200s' # Set a longer timeout (20 minutes = 1200 seconds) for the entire build.

options:
  logging: 'CLOUD_LOGGING_ONLY'
serviceAccount: 'projects/my-project-app-477009/serviceAccounts/433503387155-compute@developer.gserviceaccount.com'
steps:
# ------------------------------------------------------------------------------
# 1Ô∏è‚É£ BUILD PHASE: Build the Docker image
# ------------------------------------------------------------------------------
- name: 'gcr.io/cloud-builders/docker'
  id: 'Build Docker Image'
  args:
    - 'build'
    - '-t'
    - 'us-central1-docker.pkg.dev/my-project-app-477009/my-artifact-repo/gke-rest-api:latest'
    - '.'
  env:
    - 'CLOUDSDK_COMPUTE_ZONE=us-central1-a'

# ------------------------------------------------------------------------------
# 2Ô∏è‚É£ PUSH PHASE: Push the Docker image to Artifact Registry
# ------------------------------------------------------------------------------
- name: 'gcr.io/cloud-builders/docker'
  id: 'Push Docker Image'
  args:
    - 'push'
    - 'us-central1-docker.pkg.dev/my-project-app-477009/my-artifact-repo/gke-rest-api:latest'

# ------------------------------------------------------------------------------
# 3Ô∏è‚É£ DEPLOY PHASE: Deploy the application to GKE (apply manifests + wait for rollout)
# ------------------------------------------------------------------------------
- name: 'gcr.io/cloud-builders/gcloud'
  id: 'Deploy to GKE'
  entrypoint: 'bash'
  args:
    - '-c'
    - |
      echo "üì¶ Starting deployment to GKE for project my-project-app-477009..."

      gcloud container clusters get-credentials product-gke-cluster \
        --zone=us-central1-a \
        --project=my-project-app-477009

      echo "üîß Updating image tag in k8s/deployment.yaml with image: us-central1-docker.pkg.dev/my-project-app-477009/my-artifact-repo/gke-rest-api:latest..."
      sed -i "s|COMMIT_SHA_PLACEHOLDER|${COMMIT_SHA}|g" k8s/deployment.yaml

      echo "üöÄ Applying updated Kubernetes manifests..."
      kubectl apply -f k8s/deployment.yaml
      kubectl apply -f k8s/service.yaml

      echo "‚è≥ Waiting for deployment rollout to finish (timeout: 3m)..."
      # This waits until the deployment's pods are available or times out
      kubectl rollout status deployment/gke-rest-api --timeout=180s || (echo "‚ö†Ô∏è Rollout did not finish within timeout." && kubectl get pods -o wide && exit 1)

      echo "‚úÖ Deployment manifests applied and rollout complete."

  env:
    - 'CLOUDSDK_COMPUTE_ZONE=us-central1-a'

# ------------------------------------------------------------------------------
# 4Ô∏è‚É£ POST-DEPLOYMENT CHECKS: Verify the deployment and application health (with diagnostics)
# ------------------------------------------------------------------------------
- name: 'gcr.io/cloud-builders/gcloud'
  id: 'Post-Deployment Checks'
  entrypoint: 'bash'
  args:
    - '-c'
    - |
      echo "üîç Running enhanced health checks..."

      LB_IP=""
      MAX_RETRIES=12
      RETRY_COUNT=0

      # Wait for LoadBalancer IP
      while [ -z "$$LB_IP" ] && [ $$RETRY_COUNT -lt $$MAX_RETRIES ]; do
        echo "Waiting for LoadBalancer IP... (Retry $$RETRY_COUNT/$$MAX_RETRIES)"
        sleep 10
        LB_IP=$(kubectl get svc gke-rest-api-service -o jsonpath='{.status.loadBalancer.ingress[0].ip}' --ignore-not-found)
        RETRY_COUNT=$((RETRY_COUNT + 1))
      done

      if [ -z "$$LB_IP" ]; then
        echo "‚ùå LoadBalancer IP not found after $$MAX_RETRIES retries. Gathering diagnostics..."
        kubectl get svc gke-rest-api-service -o yaml || true
        kubectl describe svc gke-rest-api-service || true
        kubectl get pods -l app=gke-rest-api -o wide || true
        kubectl describe deployment gke-rest-api || true
        kubectl get events --sort-by=.metadata.creationTimestamp | tail -n 50 || true
        exit 1
      fi

      echo "‚úÖ LoadBalancer IP found: $$LB_IP"

      # Detect service port so we curl the correct port
      SVC_PORT=$(kubectl get svc gke-rest-api-service -o jsonpath='{.spec.ports[0].port}')
      TARGET_PORT=$(kubectl get svc gke-rest-api-service -o jsonpath='{.spec.ports[0].targetPort}')
      echo "Service port: $$SVC_PORT  TargetPort: $$TARGET_PORT"

      # Try curling the service endpoint with retries and connection-refused handling
      HEALTH_PATH="/products"
      SUCCESS=0
      ATTEMPTS=8
      for i in $(seq 1 $$ATTEMPTS); do
        echo "Attempt $$i/$$ATTEMPTS: curling http://$$LB_IP:$$SVC_PORT$$HEALTH_PATH ..."
        # retry on connection refused; -f returns non-zero for HTTP 4xx/5xx
        curl --max-time 6 --retry 5 --retry-connrefused --retry-delay 2 -f "http://$$LB_IP:$$SVC_PORT$$HEALTH_PATH" && SUCCESS=1 && break || echo "Attempt $$i failed, will retry..."
        sleep 5
      done

      if [ $$SUCCESS -ne 1 ]; then
        echo "‚ùå Health check failed after $$ATTEMPTS attempts. Gathering diagnostics..."

        echo "---- Pods ----"
        kubectl get pods -l app=gke-rest-api -o wide || true

        echo "---- Describe Deployment ----"
        kubectl describe deployment gke-rest-api || true

        echo "---- Describe Service ----"
        kubectl describe svc gke-rest-api-service || true

        echo "---- Recent Pod Logs (tail=200) ----"
        # Attempt to get logs from pods matching label; adjust label if different
        PODS=$(kubectl get pods -l app=gke-rest-api -o name || true)
        if [ -n "$$PODS" ]; then
          for p in $$PODS; do
            echo "---- Logs for $$p ----"
            kubectl logs $$p --tail=200 || true
          done
        else
          echo "No pods found to fetch logs from."
        fi

        echo "---- Recent events ----"
        kubectl get events --sort-by=.metadata.creationTimestamp | tail -n 50 || true

        exit 1
      fi

      echo "‚úÖ Health check passed: endpoint returned success."

# ------------------------------------------------------------------------------
# 5Ô∏è‚É£ IMAGES: List images built by this pipeline to be stored in Artifact Registry
# ------------------------------------------------------------------------------
images:
  - 'us-central1-docker.pkg.dev/my-project-app-477009/my-artifact-repo/gke-rest-api:latest'
